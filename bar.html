<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bar - Planning</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Includi PDF.js tramite CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
     <!-- Open Graph tags -->
  
</head>
<body>
    <header>
        <h1>Planning Bar</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
            </ul>
        </nav>
    </header>
<main>
  <section>
    <h2>Planning hebdomadaire</h2>
    <ul>
      <li>
        <a href="https://drive.google.com/file/d/1SLNgQCB3ZXopTxLk1CWP--PNxvTEzLS-/view?usp=drivesdk" target="_blank">Planning semaine en cours</a>
      </li>
      <li>
        <a href="https://drive.google.com/file/d/1VcXwl2xULtHb1ISHiSGytSczMW2tpHDV/view?usp=sharing" target="_blank">Planning prochaine semaine</a>
      </li>
    </ul>
  </section>

  <section>
    <h2>Planning Mensuel</h2>
    <ul>
      <li>
        <a href="https://drive.google.com/file/d/1CsEbQtyK26sO1XkKOVWgJ0FEFPM7zal8/view?usp=sharing" target="_blank">Planning du mois en cours</a>
      </li>
      <li>
        <a href="https://drive.google.com/file/d/1pIfNK2fbHp2OIewRLHaibCLC9bURh59p/view?usp=sharing" target="_blank">Planning du mois prochain</a>
      </li>
    </ul>
  </section>

  <section>
    <h2>Planning da Google Sheets</h2>
    <p>Carica i planning direttamente da Google Sheets:</p>
    <button onclick="loadGoogleSheets()">Carica Planning da Google Sheets</button>
    <div id="loadingMessage" style="display:none; color: #76d7c4; margin: 10px 0;">
      Caricamento dati in corso...
    </div>
    
    <div id="planningSelector" style="display:none;">
      <label for="personSelect">Seleziona Persona:</label>
      <select id="personSelect">
        <option value="">-- Seleziona --</option>
      </select>
      
      <div style="margin-top: 15px;">
        <button onclick="saveToFirebase()" style="background-color: #ff6b35; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
          ðŸ”¥ Salva su Firebase
        </button>
        <button onclick="loadFromFirebase()" style="background-color: #ffc107; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
          ðŸ“¥ Carica da Firebase
        </button>
        <button onclick="exportToExcel()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
          ðŸ“Š Esporta Excel
        </button>
        <button onclick="exportPersonToExcel()" style="background-color: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
          ðŸ‘¤ Esporta Persona
        </button>
      </div>
    </div>

    <div id="result"></div>
  </section>

  <section>
    <h2>Planning Locale (Excel)</h2>
    <p>Oppure carica un file Excel locale:</p>
    <input type="file" id="excelFile" accept=".xlsx,.xls" />
    <button onclick="loadExcelFile()">Carica Planning Excel</button>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let planningData = [];
    const DAYS = ["Lu", "Ma", "Me", "Je", "Ve", "Sa", "Di"];
    
    // ID del Google Sheets estratto dal link
    const SHEET_ID = "1QL0gE63O0ljvB8WylRSgQCtZ6YQSi4t";
    
    async function loadGoogleSheets() {
      const loadingMessage = document.getElementById('loadingMessage');
      loadingMessage.style.display = 'block';
      
      try {
        // URL per accesso pubblico al CSV del Google Sheets
        const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
        
        const response = await fetch(csvUrl);
        if (!response.ok) {
          throw new Error('Errore nel caricamento del foglio Google');
        }
        
        const csvText = await response.text();
        planningData = parseCSV(csvText);
        
        if (planningData.length === 0) {
          throw new Error('Nessun dato trovato nel foglio');
        }
        
        populatePersonSelect();
        document.getElementById('planningSelector').style.display = 'block';
        loadingMessage.style.display = 'none';
        
        alert('Dati caricati con successo da Google Sheets!');
      } catch (error) {
        console.error('Errore:', error);
        loadingMessage.style.display = 'none';
        alert('Errore nel caricamento: ' + error.message + '\n\nAssicurati che il foglio Google sia pubblico o condiviso.');
      }
    }
    
    function parseCSV(csvText) {
      const lines = csvText.split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
          const row = {};
          
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });
          
          if (row[headers[0]]) { // Se la prima colonna (Nome) non Ã¨ vuota
            data.push(row);
          }
        }
      }
      
      return data;
    }

    function loadExcelFile() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Seleziona un file Excel');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        planningData = XLSX.utils.sheet_to_json(sheet);
        
        populatePersonSelect();
        document.getElementById('planningSelector').style.display = 'block';
      };
      reader.readAsArrayBuffer(file);
    }

    function populatePersonSelect() {
      const personSelect = document.getElementById("personSelect");
      personSelect.innerHTML = '<option value="">-- Seleziona --</option>';
      
      planningData.forEach(row => {
        if (row["Nome"]) {
          const option = document.createElement("option");
          option.value = row["Nome"];
          option.textContent = row["Nome"];
          personSelect.appendChild(option);
        }
      });

      personSelect.addEventListener("change", function() {
        const selectedPerson = this.value;
        if (selectedPerson) {
          showPersonPlanning(selectedPerson);
        }
      });
    }

    function showPersonPlanning(person) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      const personData = planningData.find(row => row["Nome"] === person);
      if (!personData) {
        resultDiv.innerHTML = "<p>Nessun dato trovato per la persona selezionata.</p>";
        return;
      }

      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.marginTop = "20px";
      
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr style="background-color: #76d7c4; color: white;">
          <th style="padding: 10px; border: 1px solid #ddd;">Giorno</th>
          <th style="padding: 10px; border: 1px solid #ddd;">Orario</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      DAYS.forEach(day => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${day}</td>
          <td style="padding: 10px; border: 1px solid #ddd;">${personData[day] || "Riposo"}</td>
        `;
        tbody.appendChild(row);
      });
      table.appendChild(tbody);

      resultDiv.appendChild(table);
    }

    // Funzione per esportare tutti i planning in Excel
    async function exportToExcel() {
      if (planningData.length === 0) {
        alert('Nessun dato da esportare. Carica prima i planning.');
        return;
      }

      try {
        const response = await fetch('/api/export-excel', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            data: planningData,
            filename: `planning_completo_${new Date().toISOString().split('T')[0]}`
          })
        });

        if (!response.ok) {
          throw new Error('Errore nel server');
        }

        // Scarica il file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `planning_completo_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        alert('File Excel esportato con successo!');
      } catch (error) {
        console.error('Errore nell\'esportazione:', error);
        alert('Errore nell\'esportazione del file Excel');
      }
    }

    // Funzione per esportare solo la persona selezionata
    async function exportPersonToExcel() {
      const personSelect = document.getElementById("personSelect");
      const selectedPerson = personSelect.value;
      
      if (!selectedPerson) {
        alert('Seleziona prima una persona');
        return;
      }

      const personData = planningData.find(row => row["Nome"] === selectedPerson);
      if (!personData) {
        alert('Dati della persona non trovati');
        return;
      }

      // Trasforma i dati in formato tabellare per Excel
      const exportData = DAYS.map(day => ({
        Giorno: day,
        Orario: personData[day] || "Riposo",
        Persona: selectedPerson
      }));

      try {
        const response = await fetch('/api/export-excel', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            data: exportData,
            filename: `planning_${selectedPerson.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}`
          })
        });

        if (!response.ok) {
          throw new Error('Errore nel server');
        }

        // Scarica il file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `planning_${selectedPerson.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        alert(`Planning di ${selectedPerson} esportato con successo!`);
      } catch (error) {
        console.error('Errore nell\'esportazione:', error);
        alert('Errore nell\'esportazione del file Excel');
      }
    }

    // Funzione per salvare su Firebase
    async function saveToFirebase() {
      if (planningData.length === 0) {
        alert('Nessun dato da salvare. Carica prima i planning.');
        return;
      }

      const week = prompt('Inserisci la settimana (formato YYYY-MM-DD):') || new Date().toISOString().split('T')[0];
      const department = prompt('Inserisci il dipartimento:') || 'Bar';

      try {
        const response = await fetch('/api/save-planning', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            planningData: planningData,
            week: week,
            department: department
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert(`Planning salvato con successo su Firebase! (${result.totalPersons} persone)`);
        } else {
          throw new Error(result.error || 'Errore sconosciuto');
        }
      } catch (error) {
        console.error('Errore nel salvare su Firebase:', error);
        alert('Errore nel salvare su Firebase: ' + error.message);
      }
    }

    // Funzione per caricare da Firebase
    async function loadFromFirebase() {
      const department = prompt('Inserisci il dipartimento da caricare (opzionale):') || '';
      const week = prompt('Inserisci la settimana da caricare (formato YYYY-MM-DD, opzionale):') || '';

      try {
        const params = new URLSearchParams();
        if (department) params.append('department', department);
        if (week) params.append('week', week);

        const response = await fetch(`/api/get-planning?${params.toString()}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // Converti i dati Firebase nel formato usato dall'app
          planningData = result.data.map(item => ({
            Nome: item.nome,
            Lu: item.lunedi,
            Ma: item.martedi,
            Me: item.mercoledi,
            Je: item.giovedi,
            Ve: item.venerdi,
            Sa: item.sabato,
            Di: item.domenica
          }));

          populatePersonSelect();
          document.getElementById('planningSelector').style.display = 'block';
          
          alert(`Planning caricato da Firebase! (${result.totalPersons} persone)`);
        } else {
          alert('Nessun planning trovato con i criteri specificati.');
        }
      } catch (error) {
        console.error('Errore nel caricare da Firebase:', error);
        alert('Errore nel caricare da Firebase: ' + error.message);
      }
    }
  </script>
</body>
</html>
