<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bar - Planning</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Includi PDF.js tramite CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
     <!-- Open Graph tags -->
  
</head>
<body>
    <header>
        <h1>Planning Bar</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
            </ul>
        </nav>
    </header>
<main>
  <section>
    <h2>Planning hebdomadaire</h2>
    <ul>
      <li>
        <a href="https://drive.google.com/file/d/1SLNgQCB3ZXopTxLk1CWP--PNxvTEzLS-/view?usp=drivesdk" target="_blank">Planning semaine en cours</a>
      </li>
      <li>
        <a href="https://drive.google.com/file/d/1VcXwl2xULtHb1ISHiSGytSczMW2tpHDV/view?usp=sharing" target="_blank">Planning prochaine semaine</a>
      </li>
    </ul>
  </section>

  <section>
    <h2>Planning Mensuel</h2>
    <ul>
      <li>
        <a href="https://drive.google.com/file/d/1CsEbQtyK26sO1XkKOVWgJ0FEFPM7zal8/view?usp=sharing" target="_blank">Planning du mois en cours</a>
      </li>
      <li>
        <a href="https://drive.google.com/file/d/1pIfNK2fbHp2OIewRLHaibCLC9bURh59p/view?usp=sharing" target="_blank">Planning du mois prochain</a>
      </li>
    </ul>
  </section>

  <!-- üîé Estrazione planning per persona -->
  <section>
    <h2>Estrai planning per persona</h2>

   <form id="extract-form" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
  <label>
    <span>Persona</span><br />
    <select id="person-select" required>
      <option value="">-- Seleziona --</option>
    </select>
  </label>

  <label>
    <span>Settimana</span><br />
    <select id="week-select">
      <option value="current">Semaine en cours</option>
      <option value="next">Prochaine semaine</option>
    </select>
  </label>

  <button type="submit">Estrai</button>
</form>

<div id="status"></div>
<div id="result"></div>


    <div id="status" aria-live="polite" style="margin-top:10px;"></div>
    <div id="result" style="margin-top:16px;"></div>
  </section>

  <!-- Canvas di anteprima PDF (opzionale) -->
  <section>
    <h2>Anteprima</h2>
    <canvas id="pdf-canvas"></canvas>
  </section>
</main>

<script>
  // Costanti generali
  const DAY_LABELS = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"]; // Giorni della settimana
  const DRIVE_WEEK_CURRENT = "ID_FILE_CORRENTE"; // ID del file PDF corrente su Google Drive
  const DRIVE_WEEK_NEXT = "ID_FILE_PROSSIMO"; // ID del file PDF della prossima settimana

  // Funzione per normalizzare il testo
  function normalize(text) {
    return text.trim().toLowerCase().replace(/\s+/g, " ");
  }

  // Funzione per filtrare i nomi
  function filterNames(names) {
    const dayAliases = DAY_LABELS.map(normalize);
    return names.filter(n => {
      const nn = normalize(n);
      if (dayAliases.some(d => nn.includes(d))) return false;
      if (/^(planning|bar|service|poste|equipe|team|horaire|orari)\b/i.test(nn)) return false;
      return true;
    });
  }

  // Funzione per raggruppare righe
  function groupRows(items) {
    const rows = [];
    items.forEach(item => {
      const y = Math.round(item.transform[5]); // Coordinata Y arrotondata
      const row = rows.find(r => Math.abs(r.y - y) < 5); // Trova righe vicine
      if (row) {
        row.items.push(item);
      } else {
        rows.push({ y, items: [item] });
      }
    });
    return rows.map(r => r.items.sort((a, b) => a.x - b.x)); // Ordina per X
  }

  // Funzione per rilevare intestazione e colonne
  function detectHeaderAndColumns(rows) {
    for (const row of rows) {
      const days = row.map(item => normalize(item.str));
      const colXs = [];
      DAY_LABELS.forEach((day, i) => {
        const index = days.findIndex(d => d.startsWith(normalize(day)));
        if (index !== -1) colXs.push(row[index].x);
      });
      if (colXs.length === DAY_LABELS.length) {
        return { row, colXs };
      }
    }
    return null;
  }

  // Funzione per trovare la riga di una persona
  function findPersonRow(rows, person) {
    const normalizedPerson = normalize(person);
    return rows.find(row => row.some(item => normalize(item.str) === normalizedPerson));
  }

  // Funzione per creare una mappa giorno-attivit√†
  function rowToDayMap(personRow, colXs) {
    const dayMap = {};
    for (let i = 0; i < colXs.length; i++) {
      const colX = colXs[i];
      const cell = personRow.find(item => Math.abs(item.x - colX) < 5); // Tolleranza di 5px
      const day = DAY_LABELS[i];
      dayMap[day] = cell ? cell.str : "Nessuna attivit√†"; // Se non c'√® testo, lascia vuoto
    }
    return dayMap;
  }

  // Funzione per renderizzare il risultato
  function renderResult(container, person, week, dayMap) {
    container.innerHTML = `<h3>Attivit√† per ${person} (${week})</h3>`;
    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>Giorno</th>
          <th>Attivit√†</th>
        </tr>
      </thead>
      <tbody>
        ${Object.entries(dayMap).map(([day, activity]) => `
          <tr>
            <td>${day}</td>
            <td>${activity}</td>
          </tr>
        `).join("")}
      </tbody>
    `;
    container.appendChild(table);
  }

  // Funzione per caricare il PDF (mock per esempio)
  async function loadPdf(url) {
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';
    const pdf = await pdfjsLib.getDocument(url).promise;
    return pdf;
  }

  // Funzione per ottenere tutti gli elementi di testo dal PDF
  async function getAllTextItems(pdf) {
    const pages = [];
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      pages.push({ items: textContent.items });
    }
    return pages;
  }

  // Funzione per ottenere URL diretto del file su Drive
  function driveDirectUrl(fileId) {
    return `https://drive.google.com/uc?export=download&id=${fileId}`;
  }

  // Event listener per il cambio di settimana
  weekSelect.addEventListener("change", async () => {
    resultEl.innerHTML = "";
    personSelect.innerHTML = "<option>Caricamento‚Ä¶</option>";
    personSelect.disabled = true;
    manualInputEl.style.display = "none";
    manualInputEl.value = "";
    statusEl.textContent = "Carico PDF e cerco i nomi‚Ä¶";

    const id = (weekSelect.value === "current") ? DRIVE_WEEK_CURRENT : DRIVE_WEEK_NEXT;
    const url = driveDirectUrl(id);

    try {
      const pdf = await loadPdf(url);
      const pages = await getAllTextItems(pdf);
      const allItems = pages.flatMap(p => p.items);

      if (!allItems.length) {
        statusEl.textContent = "Il PDF non contiene testo estraibile (probabile scansione).";
        return;
      }

      const rows = groupRows(allItems);
      const headerInfo = detectHeaderAndColumns(rows);

      if (!headerInfo) {
        statusEl.textContent = "Non trovo l'intestazione con i giorni (Lun/Mar/‚Ä¶).";
        return;
      }

      const names = filterNames(rows.flatMap(row => row.map(item => item.str)));
      personSelect.innerHTML = '<option value="">-- Seleziona --</option>';
      if (names.length) {
        names.forEach(n => {
          const opt = document.createElement("option");
          opt.value = n;
          opt.textContent = n;
          personSelect.appendChild(opt);
        });
        personSelect.disabled = false;
        statusEl.textContent = `Trovati ${names.length} nomi.`;
      } else {
        statusEl.textContent = "Non ho trovato nomi nel PDF.";
        manualInputEl.style.display = "inline-block";
        manualInputEl.focus();
      }
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Errore nel caricamento/analisi del PDF (controlla link Drive e permessi).";
    }
  });

  // Event listener per il submit del form
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    resultEl.innerHTML = "";

    const selected = personSelect.disabled ? "" : (personSelect.value || "").trim();
    const manual = (!personSelect.disabled ? "" : (manualInputEl.value || "").trim());
    const person = selected || manual;
    const weekSel = weekSelect.value;

    if (!person) {
      statusEl.textContent = "Seleziona o digita un nome.";
      return;
    }

    const fileId = (weekSel === "current") ? DRIVE_WEEK_CURRENT : DRIVE_WEEK_NEXT;
    const url = driveDirectUrl(fileId);

    statusEl.textContent = "Carico il PDF e analizzo il testo‚Ä¶";

    try {
      const pdf = await loadPdf(url);
      const pages = await getAllTextItems(pdf);
      const allItems = pages.flatMap(p => p.items);

      if (!allItems.length) {
        statusEl.textContent = "Il PDF non contiene testo estraibile (probabile scansione).";
        return;
      }

      const rows = groupRows(allItems);
      const headerInfo = detectHeaderAndColumns(rows);

      if (!headerInfo) {
        statusEl.textContent = "Non trovo l'intestazione con i giorni (Lun/Mar/‚Ä¶).";
        return;
      }

      const personRow = findPersonRow(rows, person);
      if (!personRow) {
        statusEl.textContent = `Non ho trovato ‚Äú${person}‚Äù nel PDF selezionato.`;
        return;
      }

      const dayMap = rowToDayMap(personRow, headerInfo.colXs);
      renderResult(resultEl, person, (weekSel === "current" ? "Semaine en cours" : "Prochaine semaine"), dayMap);
      statusEl.textContent = "Fatto.";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Errore nel caricamento/analisi del PDF (controlla link Drive e permessi).";
    }
  });

  // Trigger iniziale
  weekSelect.dispatchEvent(new Event("change"));
</script>

