<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bar - Planning</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Includi PDF.js tramite CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
     <!-- Open Graph tags -->

</head>
<body>
    <header>
        <h1>Planning Bar</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
            </ul>
        </nav>
    </header>
<main>
  <section>
    <h2>Planning hebdomadaire</h2>
    <ul>
      <li>
        <a href="https://drive.google.com/file/d/1SLNgQCB3ZXopTxLk1CWP--PNxvTEzLS-/view?usp=drivesdk" target="_blank">Planning semaine en cours</a>
      </li>
      <li>
        <a href="https://drive.google.com/file/d/1VcXwl2xULtHb1ISHiSGytSczMW2tpHDV/view?usp=sharing" target="_blank">Planning prochaine semaine</a>
      </li>
    </ul>
  </section>

  <section>
    <h2>Planning Mensuel</h2>
    <ul>
      <li>
        <a href="https://drive.google.com/file/d/1pIfNK2fbHp2OIewRLHaibCLC9bURh59p/view?usp=sharing" target="_blank">Planning du mois en cours</a>
      </li>
      <li>
        <a href="https://drive.google.com/file/d/1CsEbQtyK26sO1XkKOVWgJ0FEFPM7zal8/view?usp=sharing" target="_blank">Planning du mois prochain</a>
      </li>
    </ul>
  </section>

  <div id="sheetsLoadingMessage" style="display:none; color: #4285f4; margin: 10px 0; text-align: center;">
    Caricamento planning...
  </div>

  <section id="employeeSelector" style="display:none; margin-top: 30px;">
    <h2>Selection ton horaire de la semaine en cours</h2>
    <select id="employeeSelect" style="width: 100%; padding: 15px; font-size: 16px; margin-bottom: 20px;">
      <option value="">-- Seleziona il tuo nome --</option>
    </select>
  </section>

  <section id="employeeSchedule" style="display:none; margin-top: 30px;">
    <h2>I tuoi orari della settimana</h2>
    <div id="scheduleDisplay" style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    </div>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let planningData = [];

    // Carica automaticamente i dati al caricamento della pagina
    document.addEventListener('DOMContentLoaded', function() {
      loadFromGoogleSheets();
      
      const employeeSelect = document.getElementById('employeeSelect');
      if (employeeSelect) {
        employeeSelect.addEventListener('change', showEmployeeSchedule);
      }
    });

    async function loadFromGoogleSheets() {
      // Link hardcoded
      const sheetsLink = "https://docs.google.com/spreadsheets/d/1QL0gE63O0ljvB8WylRSgQCtZ6YQSi4t-/edit?usp=sharing&ouid=108324642946843384206&rtpof=true&sd=true";

      const loadingMessage = document.getElementById('sheetsLoadingMessage');
      loadingMessage.style.display = 'block';

      try {
        const response = await fetch('/api/download-google-sheets', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            sheetUrl: sheetsLink,
            sheetName: 'bar'
          })
        });

        if (!response.ok) {
          throw new Error('Errore nel caricare i dati da Google Sheets');
        }

        const result = await response.json();

        if (result.success) {
          planningData = result.data;
          populateEmployeeSelect();
          document.getElementById('employeeSelector').style.display = 'block';
          loadingMessage.style.display = 'none';
          console.log(`Dati caricati con successo! Trovati ${planningData.length} collaboratori.`);
        } else {
          throw new Error(result.error || 'Errore sconosciuto');
        }

      } catch (error) {
        console.error('Errore:', error);
        loadingMessage.style.display = 'none';
        alert('Errore nel caricare i dati: ' + error.message);
      }
    }

    function populateEmployeeSelect() {
      const select = document.getElementById('employeeSelect');
      select.innerHTML = '<option value="">-- Cherche ton nom --</option>';

      const employeeNames = [];
      
      console.log('Dati totali ricevuti da Google Sheets:', planningData.length);
      console.log('Primi 3 elementi per debug:', planningData.slice(0, 3));
      
      // I dati dal server non contengono più le intestazioni, quindi processa tutte le righe
      for (let i = 0; i < planningData.length; i++) {
        const row = planningData[i];
        
        if (row && typeof row === 'object') {
          const keys = Object.keys(row);
          if (keys.length > 0) {
            const name = row[keys[0]]; // Prima colonna = Nome collaboratore
            if (name && name.trim() && isValidEmployeeName(name)) {
              employeeNames.push(name.trim());
              console.log(`✓ Collaboratore valido trovato in riga ${i + 1}: ${name.trim()}`);
            } else if (name) {
              console.log(`✗ Nome scartato in riga ${i + 1}: "${name}" (non valido)`);
            }
          }
        }
      }

      // Rimuovi duplicati e ordina
      const uniqueNames = [...new Set(employeeNames)].sort();
      
      console.log(`📋 Collaboratori finali trovati (${uniqueNames.length}):`, uniqueNames);

      if (uniqueNames.length === 0) {
        console.error('❌ ERRORE: Nessun collaboratore trovato nei dati di Google Sheets!');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '❌ Nessun collaboratore trovato';
        select.appendChild(option);
        return;
      }

      uniqueNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
    }

    function isValidEmployeeName(name) {
      if (!name || !name.trim()) return false;
      
      const trimmedName = name.trim();
      
      // Escludi solo valori chiaramente non-nomi
      if (/^\d+h?\d*\s*-\s*\d+h?\d*$/.test(trimmedName)) return false; // orari tipo "9-17" 
      if (/^\d+:\d+\s*-\s*\d+:\d+$/.test(trimmedName)) return false; // orari tipo "09:00-17:00"
      if (/^[RDS]\s*\d+:\d+\s*-\s*\d+:\d+$/.test(trimmedName)) return false; // tipo "D 09:00-18:15"
      if (/^[RDS]$/.test(trimmedName)) return false; // solo "R", "D", "S"
      if (/^[\d\s\-h:]+$/.test(trimmedName)) return false; // solo numeri e simboli orari
      if (trimmedName === "Nom" || trimmedName === "nom") return false; // intestazione
      
      // ACCETTA TUTTI I NOMI CON ALMENO 3 CARATTERI CHE CONTENGONO LETTERE
      if (trimmedName.length < 3) return false;
      
      // Deve contenere almeno una lettera
      if (!/[a-zA-ZàáâäçèéêëìíîïñòóôöùúûüÀÁÂÄÇÈÉÊËÌÍÎÏÑÒÓÔÖÙÚÛÜ']/.test(trimmedName)) return false;
      
      return true;
    }

    function showEmployeeSchedule() {
      const selectedName = document.getElementById('employeeSelect').value;
      const scheduleDisplay = document.getElementById('scheduleDisplay');
      const scheduleSection = document.getElementById('employeeSchedule');

      if (!selectedName) {
        scheduleSection.style.display = 'none';
        return;
      }

      console.log(`🔍 Cercando dati per: "${selectedName}"`);

      // Trova la riga corrispondente al nome selezionato
      const employeeData = planningData.find(row => {
        if (row && typeof row === 'object') {
          const keys = Object.keys(row);
          const name = row[keys[0]];
          return name && name.trim() === selectedName;
        }
        return false;
      });

      if (!employeeData) {
        console.error(`❌ Dati non trovati per "${selectedName}"`);
        console.log('📊 Tutti i collaboratori disponibili:', 
          planningData.slice(1).map(row => {
            const keys = Object.keys(row || {});
            return keys.length > 0 ? row[keys[0]] : 'N/A';
          }).filter(name => name && name.trim())
        );
        alert(`Dati non trovati per ${selectedName}. Controlla la console per i dettagli.`);
        return;
      }

      console.log(`✅ Dati trovati per "${selectedName}":`, employeeData);

      // Prendi le intestazioni dalla prima riga per mappare le colonne
      const headerRow = planningData[0];
      const headerKeys = Object.keys(headerRow || {});

      console.log('📋 Intestazioni colonne dal foglio Google:', headerKeys);
      console.log('📋 Valori intestazioni:', headerRow);

      // Nomi fissi dei giorni in francese
      const fixedDayNames = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
      
      // Crea la visualizzazione degli orari
      let scheduleHTML = `<h3 style="color: #333; margin-bottom: 20px;">👤 ${selectedName}</h3>`;
      scheduleHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">';

      // Visualizza gli orari per tutti i giorni (saltando la prima colonna che è il nome)
      for (let i = 1; i < headerKeys.length && i <= 7; i++) {
        const headerKey = headerKeys[i];
        const dayName = fixedDayNames[i - 1] || `Giorno ${i}`;
        
        // Prendi l'orario dal collaboratore
        let schedule = 'Non specificato';
        if (employeeData[headerKey] !== undefined && employeeData[headerKey] !== null && employeeData[headerKey] !== '') {
          schedule = employeeData[headerKey];
        }
        
        console.log(`📅 ${dayName} (colonna: ${headerKey}):`, schedule);

        // Determina il colore del bordo in base al tipo di orario
        let borderColor = '#4285f4'; // Default blu
        if (schedule === 'R') borderColor = '#ff4444'; // Rosso per riposo
        else if (schedule.includes('D ')) borderColor = '#00aa44'; // Verde per giorno
        else if (schedule.includes('S ')) borderColor = '#ff8800'; // Arancione per sera
        else if (schedule.includes('9S')) borderColor = '#8800ff'; // Viola per 9S

        scheduleHTML += `
          <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${borderColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-weight: bold; color: ${borderColor}; margin-bottom: 5px; text-transform: capitalize;">${dayName}</div>
            <div style="font-size: 16px; color: #333; font-weight: ${schedule === 'R' ? 'bold' : 'normal'};">${schedule}</div>
          </div>
        `;
      }

      scheduleHTML += '</div>';
      
      // Aggiungi info di debug in fondo
      scheduleHTML += `<div style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px; color: #666;">
        <strong>Debug Info:</strong> Dati estratti da Google Sheets • Ultima sincronizzazione: ${new Date().toLocaleString()}
      </div>`;
      
      scheduleDisplay.innerHTML = scheduleHTML;
      scheduleSection.style.display = 'block';
    }

    
  </script>
</body>
</html>
