
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Office - Planning</title>
  <link rel="stylesheet" href="../style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
</head>
<body>
  <header>
    <h1>Planning Office</h1>
    <nav><ul><li><a href="../index.html">Home</a></li></ul></nav>
  </header>

  <main>
    <section>
      <h2>Planning hebdomadaire</h2>

      <div class="slot" data-key="weekCurrent">
        <h3>Semaine en cours</h3>
        <a id="link-weekCurrent" target="_blank" rel="noopener">Apri (se disponibile)</a>
        <form class="upload-form">
          <input type="file" accept="application/pdf" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Carica PDF</button>
          <button type="button" class="view-btn">Visualizza</button>
        </form>
        <small class="msg"></small>
      </div>

      <div class="slot" data-key="weekNext">
        <h3>Semaine prochaine</h3>
        <a id="link-weekNext" target="_blank" rel="noopener">Apri (se disponibile)</a>
        <form class="upload-form">
          <input type="file" accept="application/pdf" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Carica PDF</button>
          <button type="button" class="view-btn">Visualizza</button>
        </form>
        <small class="msg"></small>
      </div>
    </section>

    <section>
      <h2>Planning mensuel</h2>

      <div class="slot" data-key="monthCurrent">
        <h3>Mois en cours</h3>
        <a id="link-monthCurrent" target="_blank" rel="noopener">Apri (se disponibile)</a>
        <form class="upload-form">
          <input type="file" accept="application/pdf" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Carica PDF</button>
          <button type="button" class="view-btn">Visualizza</button>
        </form>
        <small class="msg"></small>
      </div>

      <div class="slot" data-key="monthNext">
        <h3>Mois prochain</h3>
        <a id="link-monthNext" target="_blank" rel="noopener">Apri (se disponibile)</a>
        <form class="upload-form">
          <input type="file" accept="application/pdf" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Carica PDF</button>
          <button type="button" class="view-btn">Visualizza</button>
        </form>
        <small class="msg"></small>
      </div>
    </section>

    <section>
      <h2>Canvas per visualizzazione PDF</h2>
      <canvas id="pdf-canvas" style="max-width:100%; border: 1px solid #ccc;"></canvas>
    </section>
  </main>

  <footer><p>&copy; 2025 Pizzeria Molino Molard</p></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    // Configurazione Firebase (sostituisci con i tuoi dati reali)
    const firebaseConfig = {
      apiKey: "TUO_API_KEY",
      authDomain: "tuo-progetto.firebaseapp.com",
      projectId: "tuo-progetto",
      storageBucket: "infosmolinomoard.appspot.com",
      appId: "1:XXXX:web:YYYY"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    // Percorsi e nomi file fissi per Office
    const folder = "public/pdfs";
    const FILES = {
      weekCurrent:  "planning-office-semaine.pdf",
      weekNext:     "planning-office-semaine-prochaine.pdf",
      monthCurrent: "planning-office-mois.pdf",
      monthNext:    "planning-office-mois-prochain.pdf",
    };

    // Carica i link disponibili
    async function setLinks() {
      for (const [key, name] of Object.entries(FILES)) {
        const a = document.getElementById(`link-${key}`);
        try {
          const url = await getDownloadURL(ref(storage, `${folder}/${name}`));
          a.href = url;
          a.textContent = "Apri PDF";
          a.style.opacity = 1;
          a.style.pointerEvents = "auto";
        } catch {
          a.removeAttribute("href");
          a.textContent = "Non disponibile";
          a.style.opacity = 0.6;
          a.style.pointerEvents = "none";
        }
      }
    }

    // Renderizza una pagina nel canvas con PDF.js
    async function viewPath(storagePath) {
      try {
        const url = await getDownloadURL(ref(storage, storagePath));
        const loadingTask = pdfjsLib.getDocument({ url });
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.getElementById("pdf-canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        console.log("✅ PDF visualizzato correttamente");
      } catch (error) {
        console.error("❌ Errore visualizzazione PDF:", error);
        alert("Errore nel visualizzare il PDF: " + error.message);
      }
    }

    // Gestisci i 4 slot
    function mountSlots() {
      const slots = document.querySelectorAll(".slot");
      slots.forEach(slot => {
        const key = slot.dataset.key;
        const fixedName = FILES[key];
        const form = slot.querySelector(".upload-form");
        const msg = slot.querySelector(".msg");
        const viewBtn = slot.querySelector(".view-btn");

        // Upload con password
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.textContent = "⏳ Caricamento...";
          const fileInput = form.querySelector('input[type="file"]');
          const passInput = form.querySelector('input[type="password"]');
          const file = fileInput.files[0];
          
          if (!file || file.type !== "application/pdf") {
            msg.textContent = "❌ Seleziona un file PDF valido";
            return;
          }

          // Rinomina il file con il nome fisso
          const renamed = new File([file], fixedName, { type: "application/pdf" });
          const data = new FormData();
          data.append("file", renamed);
          data.append("password", passInput.value);

          try {
            const res = await fetch("/api/uploadPdf", { method: "POST", body: data });
            const out = await res.json();
            if (!out.success) throw new Error(out.error || "Errore upload");
            msg.textContent = "✅ Caricato correttamente";
            await setLinks();
            await viewPath(`${folder}/${fixedName}`);
            fileInput.value = "";
            passInput.value = "";
          } catch (err) {
            msg.textContent = "❌ " + err.message;
            console.error("Errore upload:", err);
          }
        });

        // Visualizza nel canvas
        viewBtn.addEventListener("click", async () => {
          try {
            await viewPath(`${folder}/${fixedName}`);
          } catch {
            alert("File non disponibile. Caricalo prima.");
          }
        });
      });
    }

    // Inizializzazione
    (async () => {
      try {
        await setLinks();
        mountSlots();
        console.log("✅ Sistema Office PDF inizializzato");
      } catch (error) {
        console.error("❌ Errore inizializzazione:", error);
      }
    })();
  </script>
</body>
</html>
