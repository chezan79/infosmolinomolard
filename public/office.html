<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Office - Planning</title>
  <link rel="stylesheet" href="style.css" />
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
</head>
<body>
  <header>
    <h1>Planning Office</h1>
    <nav><ul><li><a href="index.html">Home</a></li></ul></nav>
  </header>

  <main>
    <section>
      <h2>Planning hebdomadaire</h2>

      <div class="slot" data-key="weekCurrent">
        <h3>Semaine en cours</h3>
        <a id="link-weekCurrent" target="_blank" rel="noopener">Apri PDF</a>
        <form class="upload-form">
          <input type="file" accept="application/pdf" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Carica PDF</button>
          <button type="button" class="view-btn">Visualizza</button>
        </form>
        <small class="msg"></small>
      </div>

      <div class="slot" data-key="weekNext">
        <h3>Semaine prochaine</h3>
        <a id="link-weekNext" target="_blank" rel="noopener">Apri PDF</a>
        <form class="upload-form">
          <input type="file" accept="application/pdf" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Carica PDF</button>
          <button type="button" class="view-btn">Visualizza</button>
        </form>
        <small class="msg"></small>
      </div>
    </section>

    <section>
      <h2>Planning mensuel</h2>

      <div class="slot" data-key="monthCurrent">
        <h3>Mois en cours</h3>
        <a id="link-monthCurrent" target="_blank" rel="noopener">Apri PDF</a>
        <form class="upload-form">
          <input type="file" accept="application/pdf" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Carica PDF</button>
          <button type="button" class="view-btn">Visualizza</button>
        </form>
        <small class="msg"></small>
      </div>

      <div class="slot" data-key="monthNext">
        <h3>Mois prochain</h3>
        <a id="link-monthNext" target="_blank" rel="noopener">Apri PDF</a>
        <form class="upload-form">
          <input type="file" accept="application/pdf" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Carica PDF</button>
          <button type="button" class="view-btn">Visualizza</button>
        </form>
        <small class="msg"></small>
      </div>
    </section>

    <!-- Canvas per visualizzare il PDF -->
    <section>
      <h3>Anteprima PDF</h3>
      <canvas id="pdf-canvas" style="max-width:100%; border:1px solid #ccc;"></canvas>
    </section>
  </main>

  <footer><p>&copy; 2025 Pizzeria Molino Molard</p></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAa6EvC5iDxaKO8c3xW_v9TRqnJqRlzM8k",
      authDomain: "infosmolinomoard.firebaseapp.com",
      projectId: "infosmolinomoard",
      storageBucket: "infosmolinomoard.appspot.com",
      messagingSenderId: "961820278371",
      appId: "1:961820278371:web:4e9e3b1f8c2d5a6e7f8g9h"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const folder = "public/pdfs";
    const FILES = {
      weekCurrent:  "planning-semaine.pdf",
      weekNext:     "planning-semaine-prochaine.pdf",
      monthCurrent: "planning-mois.pdf",
      monthNext:    "planning-mois-prochain.pdf",
    };

    async function setLinks() {
      console.log("ðŸ”— Aggiornamento link dei PDF...");
      for (const [key, name] of Object.entries(FILES)) {
        const a = document.getElementById(`link-${key}`);
        try {
          const url = await getDownloadURL(ref(storage, `${folder}/${name}`));
          a.href = url;
          a.textContent = "Apri PDF";
          a.style.opacity = 1;
          console.log(`âœ… PDF trovato: ${name}`);
        } catch (err) {
          a.removeAttribute("href");
          a.textContent = "Non disponibile";
          a.style.opacity = 0.6;
          console.log(`âŒ PDF non trovato: ${name}`, err.code);
        }
      }
    }

    async function viewPath(storagePath) {
      console.log("ðŸ‘ï¸ Visualizzazione PDF:", storagePath);
      const url = await getDownloadURL(ref(storage, storagePath));
      const loadingTask = pdfjsLib.getDocument({ url });
      const pdf = await loadingTask.promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 1.5 });
      const canvas = document.getElementById("pdf-canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: ctx, viewport }).promise;
      console.log("âœ… PDF renderizzato nel canvas");
    }

    function mountSlots() {
      const slots = document.querySelectorAll(".slot");
      slots.forEach(slot => {
        const key = slot.dataset.key;
        const fixedName = FILES[key];
        const form = slot.querySelector(".upload-form");
        const msg = slot.querySelector(".msg");
        const viewBtn = slot.querySelector(".view-btn");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.textContent = "â³ Caricamento...";
          const fileInput = form.querySelector('input[type="file"]');
          const passInput = form.querySelector('input[type="password"]');
          const file = fileInput.files[0];
          if (!file || file.type !== "application/pdf") {
            msg.textContent = "âŒ Seleziona un PDF valido";
            return;
          }

          const renamed = new File([file], fixedName, { type: "application/pdf" });
          const data = new FormData();
          data.append("file", renamed);
          data.append("password", passInput.value);

          try {
            console.log(`ðŸ“¤ Upload PDF "${fixedName}" in corso...`);
            const res = await fetch("/api/uploadPdf", { method: "POST", body: data });
            const out = await res.json();
            if (!out.success) {
              throw new Error(out.error || "Errore upload");
            }
            console.log("âœ… PDF salvato su Firebase Storage:", out.path);
            msg.textContent = "âœ… PDF caricato: " + fixedName;
            await setLinks();
            await viewPath(`${folder}/${fixedName}`);
            fileInput.value = "";
            passInput.value = "";
          } catch (err) {
            msg.textContent = "âŒ " + err.message;
            console.error("âŒ Errore upload:", err);
          }
        });

        viewBtn.addEventListener("click", async () => {
          try {
            await viewPath(`${folder}/${fixedName}`);
          } catch (err) {
            alert("File non disponibile: " + err.message);
            console.error("âŒ Errore visualizzazione:", err);
          }
        });
      });
    }

    (async () => { 
      console.log("ðŸš€ Inizializzazione pagina Office...");
      await setLinks(); 
      mountSlots(); 
      console.log("âœ… Pagina Office pronta!");
    })();
  </script>
</body>
</html>